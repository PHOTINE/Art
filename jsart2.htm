<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>


    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u"
        crossorigin="anonymous">

    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
        crossorigin="anonymous"></script>



    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/9.9.0/css/bootstrap-slider.min.css" rel="stylesheet"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/9.9.0/bootstrap-slider.min.js"></script>

    <script>
        $(function () {
            const NUM_SQUARES = 999
            let hue = 270
            let VIB_MAG = 1.5
            let VIB_R = 2 * Math.PI / 40



            let t = 0;

            _.times(NUM_SQUARES, (n) =>
                $("#app").append($("<span class='square' \
                    style='position: relative; \
                    ' \
                    data-dx='"+ Math.random() * 10 + "' \
                    data-dy='"+ Math.random() * 10 + "' >  \
                        <span class='boundingbox' data-vx='0' data-vy='0'></span> \
                </span>"))
            )

            let lastMX, lastMY;
            let lastTime

            let mouseXV, mouseYV;


            $("body").mousemove((e) => {

                const currTime = Date.now()
                const dt = (currTime - lastTime) || 1

                mouseXV = (e.pageX - lastMX) / dt
                mouseYV = (e.pageY - lastMY) / dt

                lastMX = e.pageX
                lastMY = e.pageY
                lastTime = currTime
            })



            $(".boundingbox").mousemove((e) => {
                // console.log(mouseXV, mouseYV)

                const PUSH_SPEED = 20

                e.currentTarget.setAttribute('data-vx', mouseXV * PUSH_SPEED)
                e.currentTarget.setAttribute('data-vy', mouseYV * PUSH_SPEED)
            })

            tick = () => {
                hue += 2
                $('.square').each((i, e) => {
                    e.style.backgroundColor = " hsl(" + hue + ", " + i / NUM_SQUARES * 100 + "%, 50%)"
                    // console.log(Number($(e).attr('data-dx')))
                    // console.log($(e).find('.boundingbox').first().attr('data-vy'))

                    // f = k dx

                    // k dx/m =  a
                    let k = .1
                    let f = .05


                    let dx = Number($(e).attr('data-dx'))
                    let dy = Number($(e).attr('data-dy'))

                    let bb = $(e).find('.boundingbox').first()

                    // if(isNaN(dx))
                    //     throw new Error();

                    let vx = (Number(bb.attr('data-vx'))) - dx * k
                    let vy = (Number(bb.attr('data-vy'))) - dy * k

                    vx -= vx * f
                    vy -= vy * f

                    vx += VIB_MAG * Math.cos(t * VIB_R)
                    vy += VIB_MAG * Math.sin(t * VIB_R)


                    // console.log(vx, vy)
                    // $(e).find('.boundingbox').first().attr('data-vx', x * k /m)

                    $(e).attr('data-dx', dx + vx)
                    $(e).attr('data-dy', dy + vy)

                    bb.attr('data-vx', vx)
                    bb.attr('data-vy', vy)


                    e.style.left = $(e).attr('data-dx') + "px"
                    e.style.top = $(e).attr('data-dy') + "px"

                    t++;
                })
                setTimeout(tick, 30)
            }

            tick()

            // window.scroll(0, 150)


            // With JQuery
            $('#ex1').slider({
                formatter: function (value) {
                    return 'Current value: ' + value;
                }
            });


            $('#ex1').on("slide", function (slideEvt) {
                VIB_MAG = (slideEvt.value);
            });

            // With JQuery
            $('#rSlider').slider({
                formatter: function (value) {
                    return 'Current value: ' + value;
                }
            });


            $('#rSlider').on("slide", function (slideEvt) {
                VIB_R = (slideEvt.value);
            });



        })
    </script>
    <style>
        #app {
            width: 1428px
        }

        .square {
            display: inline-block;
            width: 18px;
            height: 18px;
            margin: 10px;
        }

        .boundingbox {
            width: 50px;
            height: 50px;
            /* border: 1px solid red; */
            position: absolute;
            top: -25px;
            left: -25px;
        }

        body {
            background: black
        }


        #ex1Slider .slider-selection {
            background: #BABABA;
        }
    </style>
</head>

<body>
    <div style="height:50px; " class="container-fluid">
        <div style="z-index:999;float:left" class="row">
            <div class="col-sm-1">
                <br />
                <br />
                
                <input style="z-index:999;float:left" id="ex1" data-slider-id='ex1Slider' type="text" data-slider-min="0" data-slider-max="8"
                    data-slider-step=".1" data-slider-value="4" />
                <br />
                <br />
                <br />

                <input style="z-index:999;float:left" id="rSlider" data-slider-id='rSlider' type="text" data-slider-min="0" data-slider-max="1"
                    data-slider-step=".1" data-slider-value=".5" />
            </div>
        </div>

        <div id="app"></div>
    </div>


</body>