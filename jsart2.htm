<head>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>


    <script>
        $(function () {
            const NUM_SQUARES = 1000
            let hue=270

            _.times(NUM_SQUARES, (n) =>
                $("#app").append($("<span class='square' \
                    style='background-color: hsl("+hue+", " + n / NUM_SQUARES * 100 + "%, 50%); \
                    position: relative; \
                    ' \
                    data-dx='"+ Math.random() * 10 + "' \
                    data-dy='"+ Math.random() * 10 + "' >  \
                        <span class='boundingbox' data-vx='0' data-vy='0'></span> \
                </span>"))
            )

            let lastMX, lastMY;
            let lastTime

            let mouseXV, mouseYV;


            $("body").mousemove((e) => {

                const currTime = Date.now()
                const dt = (currTime - lastTime) || 1

                mouseXV = (e.pageX - lastMX) / dt
                mouseYV = (e.pageY - lastMY) / dt

                lastMX = e.pageX
                lastMY = e.pageY
                lastTime = currTime
            })



            $(".boundingbox").mousemove((e) => {
                // console.log(mouseXV, mouseYV)
                
                const PUSH_SPEED = 20

                e.currentTarget.setAttribute('data-vx', mouseXV * PUSH_SPEED)
                e.currentTarget.setAttribute('data-vy', mouseYV * PUSH_SPEED)
            })

            tick = () => {
                hue+= 2
                $('.square').each((i, e) => {
                    e.style.backgroundColor=" hsl("+hue+", " + i / NUM_SQUARES * 100 + "%, 50%)"
                    // console.log(Number($(e).attr('data-dx')))
                    // console.log($(e).find('.boundingbox').first().attr('data-vy'))

                    // f = k dx

                    // k dx/m =  a
                    let k=.1
                    let f=.05


                    let dx = Number($(e).attr('data-dx')) 
                    let dy = Number($(e).attr('data-dy'))

                    let bb = $(e).find('.boundingbox').first()

                    // if(isNaN(dx))
                    //     throw new Error();

                    let vx = (Number(bb.attr('data-vx')) ) - dx*k 
                    let vy = (Number(bb.attr('data-vy')) ) - dy*k

                    vx-=vx*f
                    vy-=vy*f

                    
                    // console.log(vx, vy)
                    // $(e).find('.boundingbox').first().attr('data-vx', x * k /m)

                    $(e).attr('data-dx', dx + vx)
                    $(e).attr('data-dy', dy + vy)

                    bb.attr('data-vx', vx)
                    bb.attr('data-vy', vy)


                    e.style.left = $(e).attr('data-dx') + "px"
                    e.style.top = $(e).attr('data-dy') + "px"
                })
                setTimeout(tick, 30)
            }

            tick()

        })
    </script>
    <style>
        #app {
            width: 600px
        }

        .square {
            display: inline-block;
            width: 8px;
            height: 8px;
            margin: 5px;
        }

        .boundingbox {
            width: 50px;
            height: 50px;
            /* border: 1px solid red; */
            position: absolute;
            top: -25px;
            left: -25px;
        }

        body {
            background: black
        }
    </style>
</head>

<body>
    <div id="app"></div>


</body>